{% extends 'gova_pp/base.html' %}
{% load static %}

{% block title %}GOV APP - Message Details{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    * {
        font-family: 'Inter', sans-serif;
        box-sizing: border-box;
    }

    /* Override main-content to remove padding for chat page */
    .main-content {
        padding: 0 !important;
        background: #ffffff;
    }

    /* Chat Layout: Chat Names (20%) | Main Chat (60%) | AI (20%) */
    .chat-layout {
        display: grid;
        grid-template-columns: minmax(200px, 20%) minmax(400px, 60%) minmax(200px, 20%);
        height: calc(100vh - 20px);
        background: #ffffff;
        margin-bottom: 20px;
    }

    /* Chat Names Panel (Left) */
    .chat-names-panel {
        background: #ffffff;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chat-names-header {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chat-names-header h2 {
        font-size: 1rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .search-box {
        padding: 0.75rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .search-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.8rem;
        background: #f9fafb;
    }

    .search-input:focus {
        outline: none;
        border-color: #2D5A27;
    }

    .chat-list {
        flex: 1;
        overflow-y: auto;
    }

    .chat-item {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        padding: 0.75rem;
        cursor: pointer;
        transition: background 0.15s;
        border-left: 3px solid transparent;
        text-decoration: none;
    }

    .chat-item:hover {
        background: #f9fafb;
    }

    .chat-item.active {
        background: #f0fdf4;
        border-left-color: #2D5A27;
    }

    .chat-item-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2D5A27 0%, #4A7C3A 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
        position: relative;
    }

    .chat-item-avatar.online::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        width: 10px;
        height: 10px;
        background: #10b981;
        border: 2px solid white;
        border-radius: 50%;
    }

    .chat-item-content {
        flex: 1;
        min-width: 0;
    }

    .chat-item-name {
        font-size: 0.85rem;
        font-weight: 500;
        color: #111827;
        margin-bottom: 0.125rem;
    }

    .chat-item-preview {
        font-size: 0.75rem;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-item-time {
        font-size: 0.65rem;
        color: #9ca3af;
        flex-shrink: 0;
    }

    /* Main Chat Area (Center - 60%) */
    .main-chat {
        display: flex;
        flex-direction: column;
        background: #ffffff;
        border-right: 1px solid #e5e7eb;
    }

    .chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.875rem 1.25rem;
        border-bottom: 1px solid #f0f0f0;
        background: #ffffff;
    }

    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .chat-header-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2D5A27 0%, #4A7C3A 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .chat-header-info h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .chat-header-subject {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 0.125rem;
    }

    .chat-header-status {
        font-size: 0.7rem;
        color: #10b981;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        margin-top: 0.125rem;
    }

    .chat-header-status .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #10b981;
    }

    .chat-header-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
    }

    .chat-header-badges {
        display: flex;
        gap: 0.375rem;
    }

    .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.65rem;
        font-weight: 500;
    }

    .badge-status {
        background: #dcfce7;
        color: #166534;
    }

    .badge-priority {
        background: #fef3c7;
        color: #92400e;
    }

    .chat-header-tabs {
        display: flex;
        gap: 0.25rem;
    }

    .chat-tab {
        padding: 0.375rem 0.75rem;
        border-radius: 16px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        background: transparent;
        color: #6b7280;
    }

    .chat-tab.active {
        background: #e8f5e9;
        color: #2D5A27;
    }

    /* Messages Container */
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1.25rem;
        background: #ffffff;
    }

    .message-row {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .message-row.sent {
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .message-row.received .message-avatar {
        background: linear-gradient(135deg, #2D5A27 0%, #4A7C3A 100%);
        color: white;
    }

    .message-row.sent .message-avatar {
        background: #e8f5e9;
        color: #2D5A27;
    }

    .message-group {
        max-width: 70%;
    }

    .message-sender {
        font-size: 0.7rem;
        color: #9ca3af;
        margin-bottom: 0.25rem;
    }

    .message-row.sent .message-sender {
        text-align: right;
    }

    .message-content {
        padding: 0.75rem 1rem;
        border-radius: 16px;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .message-row.received .message-content {
        background: #f3f4f6;
        color: #1f2937;
        border-bottom-left-radius: 4px;
    }

    .message-row.sent .message-content {
        background: #dcfce7;
        color: #166534;
        border-bottom-right-radius: 4px;
    }

    /* Input Area */
    .input-container {
        padding: 0.875rem 1.25rem;
        background: #ffffff;
        border-top: 1px solid #f0f0f0;
    }

    .input-wrapper {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        background: #f9fafb;
        border-radius: 24px;
        padding: 0.375rem 0.5rem 0.375rem 1rem;
        border: 1px solid #e5e7eb;
    }

    .input-wrapper:focus-within {
        border-color: #2D5A27;
    }

    .input-field {
        flex: 1;
        min-height: 20px;
        max-height: 80px;
        padding: 0.5rem 0;
        border: none;
        background: transparent;
        resize: none;
        font-size: 0.875rem;
        font-family: 'Inter', sans-serif;
        color: #374151;
    }

    .input-field::placeholder {
        color: #9ca3af;
    }

    .input-field:focus {
        outline: none;
    }

    .send-btn {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: #2D5A27;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .send-btn:hover {
        background: #1A3316;
    }

    .attach-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: transparent;
        color: #9ca3af;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .attach-btn:hover {
        color: #6b7280;
    }

    /* AI Panel (Right - 20%) */
    .ai-panel {
        background: #fafafa;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .ai-panel-header {
        padding: 0.875rem;
        border-bottom: 1px solid #f0f0f0;
        background: #ffffff;
    }

    .ai-panel-header h3 {
        font-size: 0.9rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .ai-panel-header h3 i {
        color: #2D5A27;
    }

    .ai-panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 0.75rem;
    }

    .ai-message {
        background: #ffffff;
        padding: 0.75rem;
        border-radius: 10px;
        margin-bottom: 0.625rem;
        font-size: 0.8rem;
        border: 1px solid #f0f0f0;
    }

    .ai-message-header {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-weight: 600;
        color: #2D5A27;
        margin-bottom: 0.25rem;
        font-size: 0.75rem;
    }

    .ai-message-text {
        color: #374151;
        line-height: 1.4;
        font-size: 0.75rem;
    }

    .ai-help-list {
        margin: 0.25rem 0 0 1rem;
        padding: 0;
        font-size: 0.75rem;
    }

    .ai-help-list li {
        margin-bottom: 0.125rem;
    }

    .quick-actions {
        padding: 0.625rem;
        border-top: 1px solid #f0f0f0;
        background: #ffffff;
    }

    .quick-actions-title {
        font-size: 0.65rem;
        font-weight: 600;
        color: #9ca3af;
        margin-bottom: 0.375rem;
        text-transform: uppercase;
    }

    .action-btn {
        display: block;
        width: 100%;
        padding: 0.375rem 0.5rem;
        margin-bottom: 0.25rem;
        background: #f3f4f6;
        border: none;
        border-radius: 6px;
        font-size: 0.7rem;
        color: #374151;
        cursor: pointer;
        text-align: left;
    }

    .action-btn:hover {
        background: #e8f5e9;
        color: #2D5A27;
    }

    .action-btn i {
        margin-right: 0.25rem;
        width: 12px;
    }

    .ai-input-container {
        padding: 0.625rem;
        background: #ffffff;
        border-top: 1px solid #f0f0f0;
    }

    .ai-input-wrapper {
        display: flex;
        gap: 0.375rem;
        align-items: center;
        background: #f9fafb;
        border-radius: 20px;
        padding: 0.25rem 0.375rem 0.25rem 0.75rem;
        border: 1px solid #e5e7eb;
    }

    .ai-input-wrapper:focus-within {
        border-color: #2D5A27;
    }

    .ai-input {
        flex: 1;
        min-height: 18px;
        max-height: 60px;
        padding: 0.375rem 0;
        border: none;
        background: transparent;
        resize: none;
        font-size: 0.75rem;
        font-family: 'Inter', sans-serif;
        color: #374151;
    }

    .ai-input::placeholder {
        color: #9ca3af;
    }

    .ai-input:focus {
        outline: none;
    }

    .ai-send-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #2D5A27;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
    }

    /* Scrollbar */
    .messages-container::-webkit-scrollbar,
    .chat-list::-webkit-scrollbar,
    .ai-panel-content::-webkit-scrollbar {
        width: 4px;
    }

    .messages-container::-webkit-scrollbar-thumb,
    .chat-list::-webkit-scrollbar-thumb,
    .ai-panel-content::-webkit-scrollbar-thumb {
        background: #e5e7eb;
        border-radius: 2px;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .chat-layout {
            grid-template-columns: 180px 1fr 180px;
        }
    }

    @media (max-width: 900px) {
        .chat-layout {
            grid-template-columns: 1fr;
        }
        .chat-names-panel, .ai-panel {
            display: none;
        }
    }

    /* Hidden utility */
    .hidden {
        display: none !important;
    }

    .typing-status {
        font-size: 0.75rem;
        color: #9ca3af;
        font-style: italic;
        padding: 0.5rem 1.25rem;
    }

    .status-text {
        color: #10b981;
    }
</style>
{% endblock %}

{% block content %}
<!-- 3-Column Chat Layout: Chat Names (20%) | Main Chat (60%) | AI (20%) -->
<div class="chat-layout">
    <!-- Chat Names Panel (20%) -->
    <div class="chat-names-panel">
        <div class="chat-names-header">
            <h2>Chats</h2>
            <i class="fas fa-edit" title="New chat"></i>
        </div>
        
        <!-- Search -->
        <div class="search-box">
            <input type="text" class="search-input" placeholder="Search chats...">
        </div>
        
        <!-- Chat List -->
        <div class="chat-list">
            <!-- Current Active Chat -->
            <a href="{% url 'gova_pp:message_detail' message.id %}" class="chat-item active">
                <div class="chat-item-avatar online">{{ message.farmer_name|slice:":1"|upper }}</div>
                <div class="chat-item-content">
                    <div class="chat-item-name">{{ message.farmer_name }}</div>
                    <div class="chat-item-preview">{{ message.message|truncatechars:25 }}</div>
                </div>
                <span class="chat-item-time">{{ message.created_at|date:"H:i" }}</span>
            </a>
            
            <!-- Other chats -->
            {% for other_msg in other_messages %}
            <a href="{% url 'gova_pp:message_detail' other_msg.id %}" class="chat-item">
                <div class="chat-item-avatar">{{ other_msg.farmer_name|slice:":1"|upper }}</div>
                <div class="chat-item-content">
                    <div class="chat-item-name">{{ other_msg.farmer_name }}</div>
                    <div class="chat-item-preview">{{ other_msg.message|truncatechars:25 }}</div>
                </div>
                <span class="chat-item-time">{{ other_msg.created_at|date:"H:i" }}</span>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Main Chat Area (60%) -->
    <div class="main-chat">
        <!-- Chat Header - Shows current conversation -->
        <div class="chat-header">
            <div class="chat-header-left">
                <div class="chat-header-avatar">{{ message.farmer_name|slice:":1"|upper }}</div>
                <div class="chat-header-info">
                    <h3>{{ message.farmer_name }}</h3>
                    <div class="chat-header-subject">{{ message.subject|truncatechars:40 }}</div>
                    <div class="chat-header-status" id="connection-status">
                        <span class="dot" id="connection-status-dot"></span>
                        <span id="connection-status-text">online</span>
                    </div>
                </div>
            </div>
            <div class="chat-header-right">
                <div class="chat-header-badges">
                    <span class="badge badge-status">{{ message.get_status_display }}</span>
                    <span class="badge badge-priority">{{ message.get_priority_display }}</span>
                </div>
                <div class="chat-header-tabs">
                    <button class="chat-tab active">Messages</button>
                    <button class="chat-tab">Info</button>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="messages-container" id="chat-messages">
            <!-- Original Message -->
            <div class="message-row received">
                <div class="message-avatar">{{ message.farmer_name|slice:":1"|upper }}</div>
                <div class="message-group">
                    <div class="message-sender">{{ message.farmer_name }}, {{ message.created_at|date:"g:i A" }}</div>
                    <div class="message-content">
                        {{ message.message }}
                        {% if message.has_image and message.image_url %}
                        <div class="message-image">
                            <img src="{{ message.image_url }}" alt="Attached image" style="max-width: 300px; border-radius: 8px; margin-top: 0.5rem;">
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Existing Replies from Database -->
            {% for reply in replies %}
            <div class="message-row {% if reply.reply_type == 'farmer_reply' %}received{% elif reply.replied_by.id == request.user.id %}sent{% else %}received{% endif %}" data-message-id="{{ reply.id }}">
                <div class="message-avatar">
                    {% if reply.reply_type == 'farmer_reply' %}
                        {{ message.farmer_name|slice:":1"|upper }}
                    {% else %}
                        {{ reply.replied_by.get_full_name|slice:":1"|upper|default:"U" }}
                    {% endif %}
                </div>
                <div class="message-group">
                    <div class="message-sender">
                        {% if reply.reply_type == 'farmer_reply' %}
                            {{ message.farmer_name }}, {{ reply.created_at|date:"g:i A" }}
                        {% elif reply.replied_by.id == request.user.id %}
                            You, {{ reply.created_at|date:"g:i A" }}
                        {% else %}
                            {{ reply.replied_by.get_full_name|default:reply.replied_by.phone_number }}, {{ reply.created_at|date:"g:i A" }}
                        {% endif %}
                    </div>
                    <div class="message-content">
                        {{ reply.reply_text }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="hidden">
            <div class="typing-status">{{ message.farmer_name }} is typing...</div>
        </div>

        <!-- Input Area -->
        <div class="input-container">
            <div class="input-wrapper">
                <input type="file" id="file-input" class="hidden" accept="image/*" multiple>
                <button class="attach-btn" onclick="document.getElementById('file-input').click()" title="Attach file">
                    <i class="fas fa-paperclip"></i>
                </button>
                <textarea id="message-input" class="input-field" placeholder="Write your message..." rows="1"></textarea>
                <button class="send-btn" id="send-button" title="Send message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- AI Panel (20%) -->
    <div class="ai-panel">
        <div class="ai-panel-header">
            <h3><i class="fas fa-robot"></i> AI Assistant</h3>
        </div>
        
        <div class="ai-panel-content" id="ai-messages">
            <!-- Context -->
            <div class="ai-message">
                <div class="ai-message-header">
                    <i class="fas fa-info-circle"></i> Context
                </div>
                <div class="ai-message-text">
                    <strong>{{ message.farmer_name }}</strong><br>
                    {{ message.subject }}<br>
                    <span class="status-text">{{ message.get_status_display }}</span> Â· {{ message.get_priority_display }}
                </div>
            </div>
            
            <!-- AI Welcome -->
            <div class="ai-message">
                <div class="ai-message-header">
                    <i class="fas fa-sparkles"></i> Assistant
                </div>
                <div class="ai-message-text">
                    I can help you:
                    <ul class="ai-help-list">
                        <li>Draft responses</li>
                        <li>Analyze images</li>
                        <li>Crop advice</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-actions-title">Quick Actions</div>
            <button class="action-btn" onclick="askAI('Draft a professional response')">
                <i class="fas fa-pen"></i> Draft Response
            </button>
            <button class="action-btn" onclick="askAI('What agricultural advice can I provide?')">
                <i class="fas fa-seedling"></i> Crop Advice
            </button>
            <button class="action-btn" onclick="askAI('Summarize this conversation')">
                <i class="fas fa-list"></i> Summarize
            </button>
        </div>
        
        <!-- AI Input -->
        <div class="ai-input-container">
            <div class="ai-input-wrapper">
                <textarea id="ai-input" class="ai-input" placeholder="Ask AI..." rows="1"></textarea>
                <button class="ai-send-btn" id="ai-send-button" title="Send to AI">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Inputs for WebSocket -->
<input type="hidden" id="thread-id" value="{{ message.id }}">
<input type="hidden" id="current-user-id" value="{{ request.user.id }}">
<input type="hidden" id="jwt-token" value="{{ jwt_token }}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/ai_assistant.js' %}"></script>
<script src="{% static 'js/crypto-utils.js' %}"></script>
<script src="{% static 'js/chat.js' %}"></script>
<script>
    // Auto-resize textareas
    document.querySelectorAll('.input-field').forEach(textarea => {
        textarea.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    });

    // Mobile tab switching
    function switchTab(tab) {
        const customerPanel = document.getElementById('customer-panel');
        const aiPanel = document.getElementById('ai-panel');
        const tabs = document.querySelectorAll('.mobile-tab');

        tabs.forEach(t => t.classList.remove('active'));

        if (tab === 'customer') {
            tabs[0].classList.add('active');
            customerPanel.classList.add('active');
            aiPanel.classList.remove('active');
        } else {
            tabs[1].classList.add('active');
            aiPanel.classList.add('active');
            customerPanel.classList.remove('active');
        }
    }

    // Initialize WebSocket chat
    document.addEventListener('DOMContentLoaded', () => {
        const threadIdEl = document.getElementById('thread-id');
        const userIdEl = document.getElementById('current-user-id');
        const tokenEl = document.getElementById('jwt-token');

        // Scroll chat to bottom on load
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Mark existing message IDs as seen to prevent duplicates
        const existingMessageIds = new Set();
        document.querySelectorAll('[data-message-id]').forEach(el => {
            existingMessageIds.add(el.dataset.messageId);
        });

        if (threadIdEl && userIdEl && tokenEl) {
            const threadId = threadIdEl.value;
            const userId = userIdEl.value;
            const token = tokenEl.value;

            console.log('ðŸš€ Initializing chat manager...');

            window.chatManager = new ChatManager(threadId, userId);
            
            // Pass existing message IDs to prevent duplicates
            existingMessageIds.forEach(id => window.chatManager.seenMessageIds.add(id));
            
            window.chatManager.connect(token);

            // Send message
            const sendButton = document.getElementById('send-button');
            const messageInput = document.getElementById('message-input');

            sendButton.addEventListener('click', () => {
                const text = messageInput.value.trim();
                if (text) {
                    window.chatManager.sendTextMessage(text);
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                }
            });

            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendButton.click();
                }
            });
        }
    });

    // AI Assistant Functions
    let aiMessageCount = 0;

    function askAI(question) {
        const aiInput = document.getElementById('ai-input');
        aiInput.value = question;
        sendAIMessage();
    }

    function sendAIMessage() {
        const aiInput = document.getElementById('ai-input');
        const text = aiInput.value.trim();

        if (!text) return;

        // Add user question to AI chat
        addAIMessage(text, 'user');
        aiInput.value = '';
        aiInput.style.height = 'auto';

        // Show loading
        const loadingId = 'loading-' + Date.now();
        addAIMessage('<div class="loading-spinner"></div> Thinking...', 'ai', loadingId);

        // Simulate AI response (replace with actual API call)
        setTimeout(() => {
            removeAIMessage(loadingId);

            // Generate contextual response based on the question
            let response = getAIResponse(text);
            addAIMessage(response, 'ai');
        }, 1500);
    }

    function getAIResponse(question) {
        const lowerQuestion = question.toLowerCase();

        if (lowerQuestion.includes('crop') || lowerQuestion.includes('agricultural')) {
            return `Based on the farmer's location and season, I recommend:
        <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
            <li>Check current weather conditions</li>
            <li>Consider drought-resistant crops</li>
            <li>Suggest irrigation best practices</li>
            <li>Provide pest control information</li>
        </ul>
        Would you like me to draft a detailed response?`;
        } else if (lowerQuestion.includes('draft') || lowerQuestion.includes('response')) {
            return `Here's a professional response draft:
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-top: 0.5rem; color: #374151;">
        "Dear ${document.querySelector('.panel-title') ? document.querySelector('.panel-title').textContent.trim().split('\n')[1].trim() : 'Farmer'},
        
        Thank you for reaching out. Based on your inquiry, I recommend...
        
        Best regards,
        Government Agricultural Extension"
        </div>
        Click "Copy to Customer Chat" to use this response.`;
        } else if (lowerQuestion.includes('summarize')) {
            return `<strong>Conversation Summary:</strong>
        <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
            <li><strong>Topic:</strong> {{ message.subject }}</li>
            <li><strong>Status:</strong> {{ message.get_status_display }}</li>
            <li><strong>Priority:</strong> {{ message.get_priority_display }}</li>
            <li><strong>Messages:</strong> ${document.querySelectorAll('#chat-messages .message-bubble').length} exchanged</li>
        </ul>`;
        } else if (lowerQuestion.includes('next steps')) {
            return `<strong>Recommended Next Steps:</strong>
        <ol style="margin-top: 0.5rem; margin-left: 1.5rem;">
            <li>Acknowledge the farmer's concern</li>
            <li>Provide specific agricultural guidance</li>
            <li>Offer follow-up resources</li>
            <li>Schedule a site visit if needed</li>
            <li>Update case status to "In Progress"</li>
        </ol>`;
        } else {
            return `I understand you're asking about "${question}". 
        
        I can help you with:
        â€¢ Agricultural advice and recommendations
        â€¢ Drafting professional responses
        â€¢ Analyzing the conversation context
        â€¢ Suggesting action items
        
        What specific aspect would you like help with?`;
        }
    }

    function addAIMessage(text, sender, id = null) {
        const aiMessages = document.getElementById('ai-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = sender === 'user' ? 'message-bubble sent' : 'ai-message';
        if (id) messageDiv.id = id;

        if (sender === 'user') {
            messageDiv.innerHTML = `
            <div class="message-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                ${text}
            </div>
            <div class="message-meta" style="justify-content: flex-end;">
                <span>${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
            </div>
        `;
        } else {
            messageDiv.innerHTML = `
            <div class="ai-message-header">
                <i class="fas fa-robot"></i>
                AI Assistant
            </div>
            <div class="ai-message-text">
                ${text}
            </div>
        `;
        }

        aiMessages.appendChild(messageDiv);
        aiMessages.scrollTop = aiMessages.scrollHeight;
    }

    function removeAIMessage(id) {
        const element = document.getElementById(id);
        if (element) element.remove();
    }

    // AI send button
    document.getElementById('ai-send-button')?.addEventListener('click', sendAIMessage);
    document.getElementById('ai-input')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendAIMessage();
        }
    });
</script>
{% endblock %}