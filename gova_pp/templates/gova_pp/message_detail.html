{% extends 'gova_pp/base.html' %}
{% load static %}

{% block title %}GOV APP - Message Details{% endblock %}

{% block extra_css %}
<style>
    /* ... (Your existing CSS styles remain here) ... */
    .message-header {
        background: linear-gradient(135deg, #395144 0%, #4E6C50 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    /* ... (rest of styles: content-card, reply-card, etc.) ... */
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Message Details</h1>
                    <p class="text-gray-600 mt-1">Communication with {{ message.farmer_name }}</p>
                </div>
                <div class="flex space-x-4">
                    <a href="{% url 'gova_pp:messages_list' %}" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Messages
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="message-header">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold mb-2">{{ message.subject }}</h2>
                    <div class="flex items-center space-x-4 text-sm opacity-90">
                        <span><i class="fas fa-user mr-1"></i>{{ message.farmer_name }}</span>
                        <span><i class="fas fa-phone mr-1"></i>{{ message.farmer_phone }}</span>
                        {% if message.farmer_location %}
                        <span><i class="fas fa-map-marker-alt mr-1"></i>{{ message.farmer_location }}</span>
                        {% endif %}
                        <span><i class="fas fa-clock mr-1"></i>{{ message.created_at|date:"M d, Y H:i" }}</span>
                    </div>
                </div>
                <div class="flex flex-col items-end space-y-2">
                    <div class="flex items-center space-x-2">
                        <span class="status-badge status-{{ message.status }}">{{ message.get_status_display }}</span>
                        <span class="priority-{{ message.priority }} font-semibold">{{ message.get_priority_display }} Priority</span>
                    </div>
                    {% if message.assigned_to %}
                    <span class="text-sm opacity-90">Assigned to {{ message.assigned_to.get_full_name|default:message.assigned_to.phone_number }}</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div class="content-card">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Original Message</h3>
                    <div class="prose max-w-none">
                        <p class="text-gray-700 whitespace-pre-wrap">{{ message.message }}</p>
                    </div>
                </div>

                {% if analysis %}
                <div class="analysis-card">
                    </div>
                {% endif %}

                <div class="content-card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-comments mr-2"></i>Conversation
                            <span id="message-count" class="text-sm font-normal text-gray-500 ml-2"></span> 
                        </h3>
                        <div id="connection-status" class="flex items-center text-sm">
                            <span class="w-2 h-2 rounded-full bg-red-500 mr-2 animate-pulse"></span>
                            <span class="text-gray-600">Connecting...</span>
                        </div>
                    </div>
                    
                    <div id="chat-messages" class="space-y-3 max-h-96 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg">
                        
                        {% if replies %}
                        {% else %}
                        <div class="text-center py-8 no-messages">
                            <i class="fas fa-comments text-gray-300 text-4xl mb-3"></i>
                            <p class="text-gray-500">No messages found in history or real-time yet.</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div id="typing-indicator" style="display: none;" class="flex items-center space-x-2 text-sm text-gray-500 italic px-4 py-2 bg-gray-100 rounded-lg mb-3">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                        </div>
                        <span>Someone is typing...</span>
                    </div>
                </div>
                
                <div class="content-card">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Send Reply</h3>
                    
                    <input type="hidden" id="thread-id" value="{{ message.id }}">  
                    <input type="hidden" id="current-user-id" value="{{ request.user.id }}">  
                    <input type="hidden" id="jwt-token" value="{{ jwt_token }}">
                    
                    <form method="post" class="reply-form" id="message-form">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="reply">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Reply Type</label>
                                <select name="reply_type" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                     {% for value, label in reply_types %}
                                     <option value="{{ value }}">{{ label }}</option>
                                     {% endfor %}
                                </select>
                            </div>
                            
                            <div class="flex justify-between items-center mt-4">
                                <div class="flex items-center space-x-3">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" name="send_sms" class="form-checkbox rounded text-green-600 mr-2">
                                        <span class="text-sm">Send via SMS</span>
                                    </label>
                                    <div class="relative">
                                        <div class="flex flex-col space-y-2">
                                            <label for="file-input" class="cursor-pointer bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded-md inline-flex items-center transition">
                                                <i class="fas fa-images mr-1"></i> Add Images
                                            </label>
                                            <input id="file-input" type="file" class="hidden" accept="image/*" multiple>
                                            <div id="file-preview" class="flex flex-wrap gap-2 mt-2"></div>
                                            <div id="upload-status" class="text-sm text-green-600 mt-1"></div>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg transition">
                                    Send Reply
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Reply Message</label>
                            <textarea id="message-input" name="reply_text" rows="5" placeholder="Type your reply here..." required class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-1"></textarea>
                        </div>
                    </form>
                </div>
            </div>

            <div class="space-y-6">
                <div class="content-card">
                   </div>
                <div class="content-card">
                   </div>
                <div class="content-card">
                   </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-auto relative">
        <!-- Close Button -->
        <button onclick="closeImageModal()" class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg z-10" title="Close">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- Modal Content -->
        <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Image from Conversation</h3>
            
            <!-- Image Display -->
            <div class="mb-4">
                <img id="modalImage" src="" alt="Chat image" class="max-w-full h-auto rounded-lg mx-auto">
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3 justify-center">
                <button onclick="analyzeModalImage()" class="bg-gradient-to-r from-[#2D5A27] to-[#4A7C3A] text-white px-6 py-3 rounded-lg hover:from-[#1A3316] hover:to-[#2D5A27] transition flex items-center gap-2 shadow-md">
                    <i class="fas fa-brain"></i>
                    Analyze with AI
                </button>
                <button onclick="downloadImage()" class="bg-[#C5D86D] hover:bg-[#B5C95A] text-[#1A3316] px-6 py-3 rounded-lg transition flex items-center gap-2 shadow-md">
                    <i class="fas fa-download"></i>
                    Download
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/crypto-utils.js' %}"></script>
<script src="{% static 'js/chat.js' %}"></script>
<script>
// Check all images for errors on page load
document.addEventListener('DOMContentLoaded', () => {
    // Check for broken images immediately after page loads
    setTimeout(() => {
        const images = document.querySelectorAll('.message-image');
        images.forEach(img => {
            if (img.complete && img.naturalHeight === 0) {
                const messageId = img.getAttribute('data-message-id');
                if (messageId && typeof handleImageError === 'function') {
                    handleImageError(img, parseInt(messageId));
                }
            }
        });
    }, 100);
    
    // Initialize WebSocket chat manager
    // ... (Full initialization script from the last response goes here) ...
    const threadIdEl = document.getElementById('thread-id');
    const userIdEl = document.getElementById('current-user-id');
    const tokenEl = document.getElementById('jwt-token');
    
    if (threadIdEl && userIdEl && tokenEl) {
        const threadId = threadIdEl.value;
        const userId = userIdEl.value;
        const token = tokenEl.value;
        
        console.log(' Initializing chat manager...');
        
        window.chatManager = new ChatManager(threadId, userId);
        window.chatManager.connect(token);
        
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');

        if (messageForm && messageInput) {
            messageForm.addEventListener('submit', (e) => {
                e.preventDefault(); 
                const text = messageInput.value.trim();
                
                if (text) {
                    window.chatManager.sendTextMessage(text);
                    messageInput.value = '';
                    window.chatManager.sendTypingStatus(false);
                    localStorage.removeItem(`draft_${threadId}`);
                } else {
                    console.warn('⚠️ Cannot send empty message');
                }
            });
            
            // Typing Indicator Handler
            messageInput.addEventListener('input', () => {
                const text = messageInput.value.trim();
                if (text.length > 0) {
                    window.chatManager.sendTypingStatus(true);
                } else {
                    window.chatManager.sendTypingStatus(false);
                }
                
                // Auto-save draft logic
                clearTimeout(window.chatManager.draftTimer); 
                window.chatManager.draftTimer = setTimeout(() => {
                    localStorage.setItem(`draft_${threadId}`, messageInput.value);
                }, 1000);
            });
            
            // Load draft on page load
            const savedDraft = localStorage.getItem(`draft_${threadId}`);
            if (savedDraft) { messageInput.value = savedDraft; }
        }
    } else {
        console.error('❌ Required elements not found. Chat initialization failed.');
    }
});

function analyzeImage(messageId) {
    // ... (analyzeImage implementation) ...
}

function handleImageError(imgElement, messageId) {
    console.warn('Image failed to load for message:', messageId);
    
    // Get the image container
    const wrapper = document.getElementById(`image-wrapper-${messageId}`);
    if (!wrapper) return;
    
    // Replace with error message and prominent delete button
    wrapper.innerHTML = `
        <div class="bg-red-50 border-2 border-red-200 rounded-lg p-6 text-center">
            <div class="mb-4">
                <i class="fas fa-image-slash text-red-400 text-5xl"></i>
            </div>
            <p class="text-red-600 font-semibold mb-2">Image Not Found</p>
            <p class="text-gray-600 text-sm mb-4">The image file is missing or has been moved.</p>
            <button onclick="deleteMessageImage(${messageId})" 
                    class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition-all duration-200 font-medium shadow-md hover:shadow-lg">
                <i class="fas fa-trash-alt mr-2"></i>Remove Broken Image
            </button>
        </div>
    `;
}

function deleteMessageImage(messageId) {
    if (!confirm('Are you sure you want to delete this image reference?')) {
        return;
    }
    
    console.log('Deleting image for message:', messageId);
    
    // Show loading state
    const wrapper = document.getElementById(`image-wrapper-${messageId}`);
    if (wrapper) {
        wrapper.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i><p class="text-gray-500 mt-2">Deleting...</p></div>';
    }
    
    // Send delete request to backend
    // Use correct URL with language prefix and hyphen (gova-pp not gova_pp)
    const currentPath = window.location.pathname;
    const languageMatch = currentPath.match(/^\/(en|sw)\//);  // Match /en/ or /sw/
    const languageCode = languageMatch ? languageMatch[1] : 'en';
    
    fetch(`/${languageCode}/gova-pp/messages/${messageId}/delete-image/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            message_id: messageId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove entire image section from UI
            const imageSection = document.getElementById(`image-section-${messageId}`);
            if (imageSection) {
                imageSection.innerHTML = '<div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center"><i class="fas fa-check-circle text-green-600 mr-2"></i><span class="text-green-700">Image reference removed successfully</span></div>';
                
                // Fade out after 3 seconds
                setTimeout(() => {
                    imageSection.style.transition = 'opacity 0.5s';
                    imageSection.style.opacity = '0';
                    setTimeout(() => imageSection.remove(), 500);
                }, 3000);
            }
        } else {
            alert('Failed to delete image: ' + (data.error || 'Unknown error'));
            // Restore the error state
            if (wrapper) {
                wrapper.innerHTML = '<div class="text-red-600 p-4">Failed to delete. Please try again.</div>';
            }
        }
    })
    .catch(error => {
        console.error('Error deleting image:', error);
        alert('Failed to delete image. Please try again.');
        if (wrapper) {
            wrapper.innerHTML = '<div class="text-red-600 p-4">Network error. Please try again.</div>';
        }
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Image Modal Functions
let currentModalImageUrl = '';
let currentModalMediaId = '';

function openImageModal(imageUrl, mediaId) {
    currentModalImageUrl = imageUrl;
    currentModalMediaId = mediaId;
    
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    
    modalImage.src = imageUrl;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    // Prevent body scroll when modal is open
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    
    // Restore body scroll
    document.body.style.overflow = '';
}

function analyzeModalImage() {
    // Get the message ID from the current page URL
    const messageId = {{ message.id }};
    
    // Close modal and trigger the existing analyze function
    closeImageModal();
    
    // Scroll to analysis section or trigger analysis
    if (typeof analyzeImage === 'function') {
        analyzeImage(messageId);
    } else {
        // Fallback: redirect to analysis
        const currentPath = window.location.pathname;
        const languageMatch = currentPath.match(/^\/(en|sw)\//);  
        const languageCode = languageMatch ? languageMatch[1] : 'en';
        window.location.href = `/${languageCode}/gova-pp/messages/${messageId}/analyze/`;
    }
}

function downloadImage() {
    if (!currentModalImageUrl) return;
    
    // Create temporary link and trigger download
    const link = document.createElement('a');
    link.href = currentModalImageUrl;
    link.download = currentModalImageUrl.split('/').pop() || 'image.jpg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});

// Close modal when clicking outside the content
document.getElementById('imageModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeImageModal();
    }
});

// Event delegation for dynamically added images in chat
// This works even if chat.js is cached!
document.addEventListener('click', function(e) {
    // Check if clicked element is an image in the conversation
    if (e.target.tagName === 'IMG' && e.target.closest('#conversation-messages')) {
        const imgSrc = e.target.src;
        const mediaId = e.target.getAttribute('data-media-id') || 'unknown';
        
        console.log('Image clicked via delegation:', imgSrc);
        openImageModal(imgSrc, mediaId);
    }
});

function insertTemplate(text) {
    const textarea = document.getElementById('message-input');
    if (textarea) {
        textarea.value = text;
        textarea.focus();
    }
}
</script>
{% endblock %}